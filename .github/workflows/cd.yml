name: Deploy

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy-dev:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    environment:
      name: dev
      # url: ${{ secrets.DEV_APP_URL }} # Secrets are not allowed here. Use vars.DEV_APP_URL if you define it as a variable.

    steps:
      - name: Deploy to dev server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT || 22 }}
          script: |
            echo "ðŸš€ Starting deployment to dev server..."

            # Navigate to project directory
            cd ${{ secrets.DEV_PROJECT_PATH }}

            # Pull latest changes (Hard Reset to match remote exactly)
            echo "ðŸ“¥ syncing with origin/dev..."
            git fetch origin dev
            git reset --hard origin/dev

            # Create .env with secrets for docker-compose
            echo "âš™ï¸  Creating .env..."
            cat > .env << EOF
            NEXT_PUBLIC_API_URL=${{ secrets.DEV_API_URL }}
            NEXT_PUBLIC_API_BASE_PATH=/api/v1
            NEXT_PUBLIC_APP_NAME=PolystirolHub
            NEXT_PUBLIC_APP_URL=${{ secrets.DEV_APP_URL }}
            NEXT_PUBLIC_DEBUG=${{ secrets.DEV_DEBUG || 'true' }}
            API_URL_INTERNAL=${{ secrets.DEV_API_URL_INTERNAL || 'http://backend-1:8000' }}
            EOF

            # Stop and remove old container
            echo "ðŸ›‘ Stopping old container..."
            docker compose down

            # Rebuild and start container
            echo "ðŸ”¨ Building and starting new container..."
            docker compose up -d --build

            # Clean up old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            # Show container status
            echo "âœ… Deployment complete! Container status:"
            docker compose ps

      - name: Deployment summary
        run: |
          echo "### Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Dev (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App URL**: ${{ secrets.DEV_APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Container has been rebuilt and restarted on dev server" >> $GITHUB_STEP_SUMMARY

  deploy-main:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    environment:
      name: production
      # url: ${{ secrets.PROD_APP_URL }} # Secrets are not allowed here. Use vars.PROD_APP_URL if you define it as a variable.

    steps:
      - name: Deploy to production server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MAIN_SSH_HOST }}
          username: ${{ secrets.MAIN_SSH_USER }}
          key: ${{ secrets.MAIN_SSH_KEY }}
          port: ${{ secrets.MAIN_SSH_PORT || 22 }}
          script: |
            echo "ðŸš€ Starting deployment to production server..."

            # Navigate to project directory
            cd ${{ secrets.PROD_SERVER_PATH }}

            # Pull latest changes (Hard Reset to match remote exactly)
            echo "ðŸ“¥ syncing with origin/main..."
            git fetch origin main
            git reset --hard origin/main

            # Create .env with secrets for docker-compose
            echo "âš™ï¸  Creating .env..."
            cat > .env << EOF
            NEXT_PUBLIC_API_URL=${{ secrets.PROD_API_URL }}
            NEXT_PUBLIC_API_BASE_PATH=/api/v1
            NEXT_PUBLIC_APP_NAME=PolystirolHub
            NEXT_PUBLIC_APP_URL=${{ secrets.PROD_APP_URL }}
            NEXT_PUBLIC_DEBUG=false
            API_URL_INTERNAL=${{ secrets.PROD_API_URL_INTERNAL || 'http://backend-1:8000' }}
            EOF

            # Stop and remove old container
            echo "ðŸ›‘ Stopping old container..."
            docker compose down

            # Rebuild and start container
            echo "ðŸ”¨ Building and starting new container..."
            docker compose up -d --build

            # Clean up old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

            # Show container status
            echo "âœ… Deployment complete! Container status:"
            docker compose ps

      - name: Deployment summary
        run: |
          echo "### Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App URL**: ${{ secrets.PROD_APP_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Container has been rebuilt and restarted on production server" >> $GITHUB_STEP_SUMMARY
